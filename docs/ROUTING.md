# Routing, Testing, and Remediation SOPs

This document outlines the routing architecture of the application, the testing strategies in place to ensure its integrity, and the standard operating procedures (SOPs) for remediating common issues.

## 1. Routing Architecture

The application uses Next.js with the App Router. Routes are defined by the directory structure within the `/app` directory.

- **Page Routes:** Defined by `page.tsx` files.
- **API Routes:** Defined by `route.ts` files.

A complete map of all application routes is automatically generated by the `bun run discover-routes` command and can be found in `reports/routes.json`.

## 2. Testing and Validation Strategy

A multi-layered testing strategy is in place to validate routing and access control. These checks are designed to be run in a CI/CD pipeline to gate pull requests.

### 2.1. API Contract Tests

- **Purpose:** To verify the behavior of API endpoints, including request/response schemas, status codes, and role-based access control.
- **Location:** `tests/api/`
- **Command:** `bun test`

### 2.2. Broken Link & Allow-List Check

- **Purpose:** To crawl all page routes and check for broken internal links or external links not on the approved allow-list.
- **Location:** `scripts/check-links.mjs`
- **Command:** `bun run check-links`

### 2.3. End-to-End (E2E) Tests

- **Purpose:** To simulate real user journeys and verify that critical flows are working as expected.
- **Location:** `tests/e2e/`
- **Command:** `bun run test:e2e`
- **Note:** Requires system dependencies for Playwright to be installed.

### 2.4. CI Integration

- **Purpose:** To run all checks in a single, unified script.
- **Command:** `bun run ci:checks`

## 3. Remediation SOPs

### 3.1. Broken Internal Link

1.  **Identify:** The `check-links` script will report the page containing the broken link and the link itself.
2.  **Verify:** Check the `reports/routes.json` file to see if the link's destination is a valid route.
3.  **Remediate:**
    - If the link is incorrect, update the source code on the page where the link was found.
    - If the route is missing, create the necessary page or API route.

### 3.2. Disallowed External Link

1.  **Identify:** The `check-links` script will report the page containing the disallowed link.
2.  **Verify:** Determine if the external link is legitimate and should be allowed.
3.  **Remediate:**
    - If the link is valid, add it to the `link-allow-list.json` file.
    - If the link is not valid, remove it from the source code.

### 3.3. E2E Test Failure

1.  **Identify:** The Playwright report will show which test failed and provide a trace.
2.  **Verify:** Run the test locally to reproduce the failure. Use the trace to debug the issue.
3.  **Remediate:**
    - If the failure is due to a code change, fix the code.
    - If the failure is due to a change in the UI, update the test to reflect the new UI.

### 3.4. Production Monitoring Alert

1.  **Identify:** The `monitor:prod` script will report a broken link in the production environment.
2.  **Verify:** Manually check the reported link in a browser to confirm that it is broken.
3.  **Remediate:**
    - This is a critical issue and should be addressed immediately.
    - Follow the steps for a broken internal link, but be aware that this is a live production issue.
    - Consider rolling back the last deployment if the fix is not immediately obvious.